msys2 third atempt, using msys2 shell

#  download and extract latest gdal from metacpan


export ST_PERL=/c/berrybrew/5.24.0_64_PDL
export GDAL_ROOT=/c/gdal_builds/gdal-2.1.2
#export GDAL_ROOT=/c/gdal_builds/gdal-2.1.0
export PATH=${ST_PERL}/c/bin:${ST_PERL}/perl/site/bin:${ST_PERL}/perl/bin:${GDAL_ROOT}:${PATH}
#  for -L
export LIBRARY_PATH=${ST_PERL}/perl/lib/CORE:${ST_PERL}/c/lib:${GDAL_ROOT}
#  for -I  (might need to edit gdal-config of Makefile.pl?)
export CPATH=${ST_PERL}/c/include:${ST_PERL}/perl/lib/CORE
export CPLUS_INCLUDE_PATH=${GDAL_ROOT}:${CPATH}
export C_INCLUDE_PATH=${CPLUS_INCLUDE_PATH}

#  add the gdal dll dir from the build dir to the path
#  if we have just built it
export PATH=${GDAL_ROOT}/.libs:${PATH}


# edit Makefile.PL to generate a make-style makefile
# WriteMakefile (
#     MAKE => 'make',
# ...
# );

#  get /mingw64/bin into the -L path somewhere
#  currently doing after this next line

perl Makefile.PL --gdal-config=${GDAL_ROOT}/apps/gdal-config --no-version-check


##  adapted from Knittel notes
# Make the following changes:

sed -i -e 's/RANLIB = rem/RANLIB = ranlib/' Makefile_*
sed -i -e 's/NOOP = rem/NOOP =/' Makefile_*
sed -i -e 's|DIRFILESEP = \\|DIRFILESEP = /|' Makefile_*
#  iostream issues - just comment it out
sed -i -e 's|^#include <iostream>|//#include <iostream>|' *wrap.cpp
#  next line should not be needed
sed -i -e 's|/mingw/bin/x86_64-w64-mingw32-g++|g++|' Makefile_*
# The paths were written in format: /c/strawberry\perl\bin\perl.exe etc, which turns into C:strawberryperlbinperl.exe.  The following should transform '\' into '/', excluding cases such as \" and \(end of line):
sed -i -e 's|\\\([^\"\\]\)|/\1|g' Makefile_*
#  and change "C:/berrybrew
sed -i -e 's|C\:/berrybrew\|c/berrybrew|g' Makefile_*

### attach -L"/c/gdal_builds/gdal-2.1.2" to LDFLAGS and LDDLFLAGS  - not needed given next line
## manually insert libgdal.dll into the c++ commands (the $(LD) lines?)
#  could edit the OTHERLDFLAGS line to be "${GDAL_ROOT}/libgdal-20.dll"
#sed -i -e 's|^OTHERLDFLAGS \=|OTHERLDFLAGS \= "/c/gdal_builds/gdal-2.1.2/.libs/libgdal-20.dll"|g' Makefile_*
sed -i -e 's|^OTHERLDFLAGS \=|OTHERLDFLAGS \= '${GDAL_HOME}'/.libs/libgdal-20.dll"|g' Makefile_*


#  now try making it
make

# then test it using strawberry perl from the windows command prompt (prove is a windows .bat file)
#  remembering to add all the relevant dirs to the path
prove -b t\00.t

